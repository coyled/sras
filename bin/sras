#!/usr/bin/env ruby

require 'optparse'
require 'yaml'
require 'thin'

options = {}
ROOT = ::File.dirname(::File.realdirpath(__FILE__))

# defaults...
options[:environment] = 'production'
options[:config_file] = '/etc/sras/sras.conf'

# look for more appropriate SRAS config file...
if File.exists?("#{ROOT}/config/config.yml")
    options[:config_file] = "#{ROOT}/config/config.yml"
elsif File.exists?(File.expand_path('~/.srasrc'))
    options[:config_file] = File.expand_path('~/.srasrc')
end

OptionParser.new do |opts|
    opts.banner = 'Usage: sras [options] <start|stop>'

    opts.on('-c', '--config <file>', 'SRAS config file') do |c|
        options[:config_file] = c
    end

    opts.on('-e', '--environment <production|development|test>',
                'Environment in which to run') do |e|
        options[:environment] = e
    end

    opts.on('-h', '--host <hostname|ip_addy>', 'Address to which to bind') do |h|
        options[:host] = h
    end

    opts.on('-p', '--port <N>', Integer, 'TCP port to which to bind') do |p|
        options[:port] = p
    end

    opts.on('-l', '--log <file>', 'Log file') do |l|
        options[:log_file] = l
    end

    opts.on('-P', '--pid <file>', 'PID file') do |p|
        options[:pid_file] = p
    end

    opts.on_tail('-h', '--help', 'Show this message') do
        puts opts
        exit
    end

    if ARGV.last
        command = ARGV.last.chomp
        if command == 'start' || command == 'stop'
            options[:command] = command
        else
            puts opts
            exit
        end
    else
        puts opts
        exit
    end 
end.parse!

# load SRAS config file...
if File.exists?(options[:config_file])
    @config = YAML.load_file(options[:config_file])
else
    warn "Couldn't find SRAS config file.  Exiting."
    exit 1
end

# base thin options...
#-d -R #{::File.dirname(__FILE__)}/../config.ru"
#thin_opts << " -e #{options[:environment]}"

if ! options[:host]
    if @config['sras'][options[:environment]]['host']
        options[:host] = @config['sras'][options[:environment]]['host']    
    else
        options[:host] = '0.0.0.0'
    end
end

if ! options[:port]
    if @config['sras'][options[:environment]]['port']
        options[:port] = @config['sras'][options[:environment]]['port']
    else
        options[:port] = '8003'
    end
end

if ! options[:log_file]
    if @config['sras'][options[:environment]]['log_file']
        options[:log_file] = @config['sras'][options[:environment]]['log_file']
    else
        options[:log_file] = "log/sras_#{options[:environment]}.log"
    end
end

if ! options[:pid_file]
    if @config['sras'][options[:environment]]['pid_file']
        options[:pid_file] = @config['sras'][options[:environment]]['pid_file']
    else
        options[:pid_file] = "/tmp/sras_#{options[:environment]}.pid"
    end
end

require "#{ROOT}/../lib/sras.rb"
server = Thin::Server.new(options[:host], options[:port], SRAS.new)
server.log_file = options[:log_file]
server.pid_file = options[:pid_file]
server.tag = 'sras'
server.start
